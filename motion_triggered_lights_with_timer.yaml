blueprint:
  name: Motion-triggered Lights with Timer
  description: >
    Automatically turns lights on/off based on motion, light state, timers, and conditions. 
    Requires a motion sensor entity, a light entity (a light group works for multiple lights), a timer 
    entity (with the time set in its configuration), and two input_boolean helpers that you must create - 
    one that controls whether the lights will be turned on automatically when motion is detected 
    (e.g. input_boolean.deck_lights_auto_on_controller) and one to control whether the lights are 
    turned off when the timer ends (e.g. input_boolean.deck_lights_auto_off_controller).
  domain: automation
  author: Scott Menzer
  input:
    trigger_sensor:
      name: Trigger Sensor
      description: "The trigger sensor (motion, occupancy, etc.) that triggers the lights."
      selector:
        entity:
          filter:
            domain: 
              - binary_sensor
              - input_boolean
    light_target:
      name: Light
      description: "The light entity to control."
      selector:
        entity:
          filter:
            domain: light
    auto_on_controller:
      name: Auto On Controller Entity
      description: "Boolean to enable/disable automatic turning on of the lights."
      selector:
        entity:
          filter:
            domain: input_boolean
    only_when_sun_is_down:
      name: Auto On Only When Sun is Down
      description: "Enable to only turn on lights when motion is detected when the sun is down (according to sun integration). Disable to turn on lights any time motion is detected."
      selector:
        boolean:
      default: true
    auto_off_controller:
      name: Auto Off Controller Entity
      description: "Boolean to enable/disable automatic turning off of the lights."
      selector:
        entity:
          filter:
            domain: input_boolean
    auto_off_timer:
      name: Timer
      description: "Timer entity to delay turning off the lights."
      selector:
        entity:
          filter:
            domain: timer
    off_transition:
      name: Time Off Transition
      description: >
        Brightness off transition
      default: 60
      selector:
        number:
          min: 0
          max: 120
          step: 1
          unit_of_measurement: seconds

variables:
  only_when_sun_is_down: !input only_when_sun_is_down

triggers:
  - trigger: state
    entity_id: !input trigger_sensor
    id: trigger-on
    to: "on"
  - trigger: state
    entity_id: !input trigger_sensor
    id: trigger-off
    to: "off"
  - trigger: state
    entity_id: !input light_target
    to: "on"
    id: light-on
  - trigger: state
    entity_id: !input light_target
    to: "off"
    from: "on"
    id: light-off
  - trigger: state
    entity_id: !input auto_off_controller
    to: "on"
    id: auto-off-enabled
  - trigger: state
    entity_id: !input auto_off_controller
    to: "off"
    id: auto-off-disabled
  - trigger: event
    event_data:
      entity_id: !input auto_off_timer
    event_type: timer.finished
    id: timer-end

conditions: []
actions:
  - choose:
      - conditions:
          - condition: trigger
            alias: "motion/occupancy detected"
            id:
              - trigger-on
        sequence:
        - if:
            - alias: "If timer is running"
              condition: state
              entity_id: !input auto_off_timer
              state: active
          then:
            - action: timer.cancel
              alias: "Cancel the timer"
              data: {}
              target:
                entity_id: !input auto_off_timer
          # check if auto-on is enabled
        - condition: state
          entity_id: !input auto_on_controller
          state: "on"
        - condition: state
          entity_id: !input light_target
          state: "off"
        - condition: or
          alias: "if after sunset or the sun_down toggle is off"
          conditions:
            - condition: sun
              before: sunrise
              after: sunset
            - condition: template
              value_template: >
                {{ only_when_sun_is_down == false }}
        - action: light.turn_on
          alias: "turn on the light(s)"
          data: {}
          target:
            entity_id: !input light_target

      - conditions:
        alias: "Start the timer - lights on, trigger-off flag enabled, or trigger sensor clears"
          - condition: trigger
            id:
              - light-on
              - trigger-off
              - auto-off-enabled
        sequence:
          - condition: state
            entity_id: !input auto_off_controller
            state: "on"
          - condition: state
            entity_id: !input trigger_sensor
            state: "off"
          - condition: state
            entity_id: !input light_target
            state: "on"
          - action: timer.start
            alias: "start the timer"
            data: {}
            target:
              entity_id: !input auto_off_timer
      - conditions:
        alias: "Cancel timer - ligts off or trigger-off flag is disabled"
          - condition: trigger
            id:
              - light-off
              - auto-off-disabled
        sequence:
          - action: timer.cancel
            metadata: {}
            data: {}
            target:
              entity_id: !input auto_off_timer
      - conditions:
          - condition: trigger
            id:
              - timer-end
        sequence:
          - condition: state
            entity_id: !input light_target
            state: "on"
          - condition: state
            entity_id: !input trigger_sensor
            state: "off"
          - condition: state
            entity_id: !input auto_off_controller
            state: "on"
          - action: light.turn_off
            metadata: {}
            data:
              entity_id: !input light_target
              transition: !input off_transition
            #target:
            #  entity_id: !input light_target

mode: queued